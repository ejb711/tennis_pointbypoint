name: Build Windows Executable

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:  # Allows manual triggering from GitHub UI

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy pandas matplotlib scipy tqdm pyinstaller

    - name: Modify app.py
      run: |
        python -c "
        import os, re
        
        # Define the resource_path function to add
        resource_func = '''
import os
import sys

def resource_path(relative_path):
    \"\"\"Get absolute path to resource, works for dev and for PyInstaller\"\"\"
    try:
        # PyInstaller creates a temp folder and stores path in _MEIPASS
        base_path = sys._MEIPASS
    except Exception:
        base_path = os.path.abspath('.')

    return os.path.join(base_path, relative_path)
'''
        
        # Read the current app.py content
        app_path = os.path.join('current_app', 'app.py')
        with open(app_path, 'r') as f:
            content = f.read()
        
        # Add the resource_path function at the beginning
        patched_content = resource_func + '\n\n' + content
        
        # Replace the CSV loading pattern
        patched_content = re.sub(r\"df = pd\\.read_csv\\('combined\\.csv'\\)\", 
                               \"df = pd.read_csv(resource_path('combined.csv'))\", 
                               patched_content)
        
        # Write the modified content back
        with open(app_path, 'w') as f:
            f.write(patched_content)
        
        print('Successfully modified app.py')
        "

    - name: Build with PyInstaller
      working-directory: current_app
      run: |
        pyinstaller --onefile --add-data "combined.csv;." app.py --name "TennisPointByPoint"

    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: TennisPointByPoint
        path: current_app/dist/TennisPointByPoint.exe
        retention-days: 30
